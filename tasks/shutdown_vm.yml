---
- name: check if VM is reachable on known ip address
  command: ping -c1 {{ vm_ip }}
  register: ping_result
  ignore_errors: yes

- debug:
    msg: |
      DEVICE={{ vm_nic }}
      HWADDR={{ vm_mac }}
      IPADDR={{ vm_ip }}
      GATEWAY={{ vm_gateway }}
      PREFIX={{ vm_mask_prefix }}
    verbosity: 2
    
- name: shutting down {{ vm_name }} to run virt-customize
  shell: |
    result=$(virsh dominfo --domain {{ vm_name }}| awk '/State/ {print $2}')
    if [ $result == 'shut' ];
    then
       echo "shutoff"
    else
      virsh shutdown {{ vm_name }};
    fi
  register: vm_shutdown_status
  until: vm_shutdown_status.stdout.find('shutoff') != -1
  retries: 18
  delay: 3
